Imports System.Drawing

Public Class Home_page
    Inherits System.Web.UI.Page
    Dim ds As DataSet
    Dim ds1 As DataSet
    Dim ds2 As DataSet
    Dim ds3 As DataSet
    Dim ds4 As DataSet
    Dim ds5 As DataSet
    Dim ds6 As DataSet
    Dim ds7 As DataSet
    Dim ds8 As DataSet
    Dim ds9 As DataSet
    Dim time As DateTime  'SQL系統時間

    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        Try
            Db.Set_Db("172.30.4.225", "DNTW_Warehouse")
            Session("Exception") = "Home_page.aspx"
            If Session("user_id") = "" Then
                Response.Redirect("Default.aspx")
            End If

            If Not Page.IsPostBack Then
                DDL()
                user_name1()
            End If
            SQL_time()
            after_4oclock()
            'dataview()
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
    Private Sub DDL()  '顯示器的下拉選單
        Try
            Dim sql As String = "select monitor from Contol_monitor ORDER BY monitor ASC"
            ds1 = Db.Get_DataSet(sql)
            DropDownList1.Items.Clear()
            DropDownList1.Items.Add("請選擇受入場")
            For k As Integer = 0 To ds1.Tables(0).Rows.Count() - 1
                Dim dr As DataRow = ds1.Tables(0).Rows(k)
                If ds1.Tables(0).Rows.Count > 0 Then
                    DropDownList1.Items.Add(dr("monitor"))
                End If
            Next
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
    Private Sub SQL_time()
        Try
            Dim sql_time As String = "select getdate() AS SERVER_TIME"
            ds1 = Db.Get_DataSet(sql_time)
            time = ds1.Tables(0).Rows(0)("SERVER_TIME").ToString()
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
    Private Sub user_name1() '權限
        Try
            user_name.Text = Session("user_name").ToString()
            Dim sql As String = "select user_id,user_dept,user_name,user_position ,user_mail ,user_group  from Exception_Login left join staff on user_id =code  where code = '" & Session("user_id").Trim() & "'"
            ds1 = Db.Get_DataSet(sql)
            If ds1.Tables(0).Rows.Count > 0 Then
                Dim dr As DataRow = ds1.Tables(0).Rows(0)
                If dr("user_group") = "承認者" Then
                    ImageButton1.Visible = True
                    ImageButton2.Visible = True
                    ImageButton3.Visible = True
                    ImageButton4.Visible = True
                    LinkButton6.Visible = True
                    LinkButton7.Visible = True
                ElseIf dr("user_group") = "檢討者" Then
                    ImageButton1.Visible = True
                    ImageButton2.Visible = True
                    ImageButton3.Visible = True
                    ImageButton4.Visible = False
                    LinkButton6.Visible = False
                    LinkButton7.Visible = False
                ElseIf dr("user_group") = "填寫者" Then
                    ImageButton1.Visible = True
                    ImageButton2.Visible = True
                    ImageButton3.Visible = True
                    ImageButton4.Visible = False
                    LinkButton6.Visible = False
                    LinkButton7.Visible = False
                Else
                    ImageButton1.Visible = True
                    ImageButton2.Visible = False
                    ImageButton3.Visible = False
                    ImageButton4.Visible = False
                    LinkButton6.Visible = False
                    LinkButton7.Visible = False
                End If
            Else
                ImageButton1.Visible = True
                ImageButton2.Visible = False
                ImageButton3.Visible = False
                ImageButton4.Visible = False
                LinkButton6.Visible = False
                LinkButton7.Visible = False
            End If
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
    Private Sub dataview()
        Try
            Dim date_time As String
            Dim date_time1 As String
            Dim ddl1 As String
            date_time = time.ToString("yyMMdd")
            date_time1 = time.ToString("yyyy/MM/dd")
            ddl1 = DropDownList1.Text()

            Dim sql As String =
"select * from ((select * from (select  CASE WHEN LEN(納入時間)=1 then CONVERT(varchar(5),'00:00') WHEN  LEN(納入時間) = 3 THEN CONVERT(varchar(5),'0'+SUBSTRING(納入時間,1,1)+':'+ SUBSTRING(納入時間 ,2,2))WHEN LEN(納入時間)=4 THEN CONVERT(varchar(5),SUBSTRING(納入時間,1,2)+':' + SUBSTRING(納入時間 ,3,2))END  AS 預定時間 ,convert(varchar(16),Contol_V_m.仕入れ先名) AS 供應商,COUNT(Box.[箱数])As 箱數   ,CONVERT (varchar(5),SUBSTRING (着荷,7,2)+':'+SUBSTRING (着荷,9,2)) AS 到貨時間 ,CONVERT (nvarchar,COUNT(Box.[検品]))+ CONVERT (nvarchar, ('/')) + CONVERT(nvarchar,COUNT(Box.[箱数])) AS　點收數,Box.[納入日],CONVERT (varchar (10),'20'+SUBSTRING(納入日,1,2)+'/'+SUBSTRING(納入日,3,2)+'/'+SUBSTRING(納入日,5,2))  As 預定日期,CONVERT (varchar (5),SUBSTRING(納入日,3,2)+'/'+SUBSTRING(納入日,5,2)) As 日期,CONVERT (varchar (19),'20'+SUBSTRING(納入日,1,2)+'-'+SUBSTRING(納入日,3,2)+'-'+SUBSTRING(納入日,5,2))+' '+CASE WHEN LEN(納入時間)=1 then CONVERT(varchar(5),'00:00') WHEN  LEN(納入時間) = 3 THEN CONVERT(varchar(19),'0'+SUBSTRING(納入時間,1,1)+':'+ SUBSTRING(納入時間 ,2,2)+':00')WHEN LEN(納入時間)=4 THEN CONVERT(varchar(19),SUBSTRING(納入時間,1,2)+':' + SUBSTRING(納入時間 ,3,2)+':00')END  AS 預定到貨時間,CONVERT (varchar(19),'20'+SUBSTRING (着荷,1,2)+'-'+SUBSTRING (着荷,3,2)+'-'+SUBSTRING (着荷,5,2)+' '+SUBSTRING (着荷,7,2)+':'+SUBSTRING (着荷,9,2))+':00' AS 實際到貨時間, CASE WHEN LEN(納入時間)=1 then CONVERT(varchar(5),'00:00') WHEN  LEN(納入時間) = 3 THEN CONVERT(varchar(5),'0'+SUBSTRING(納入時間,1,1)+':'+ SUBSTRING(納入時間 ,2,2))WHEN LEN(納入時間)=4 THEN CONVERT(varchar(5),SUBSTRING(納入時間,1,2)+':' + SUBSTRING(納入時間 ,3,2))END  AS 計畫時間,CONVERT (varchar(5),SUBSTRING (着荷,7,2)+':'+SUBSTRING (着荷,9,2)) AS 實際時間,Box.[仕入れ先コード] AS 供應商編號,COUNT(Box.[検品])As 已查收,CONVERT(varchar(19),SUBSTRING(MAX(Box.検品),1,4)+'-'+SUBSTRING(MAX(Box.検品),5,2)+'-'+SUBSTRING(MAX(Box.検品),7,2)+' '+SUBSTRING(MAX(Box.検品),9,2)+':'+SUBSTRING(MAX(Box.検品),11,2)+':'+SUBSTRING(MAX(Box.検品),13,2)) As 最後到貨時間,Contol_V_m.顯示器 AS 受入場 From BOX_Status_Table Box INNER JOIN Contol_V_m ON Box.仕入れ先コード=Contol_V_m.仕入れ先コード group by Box.[納入日],Box.[納入時間],Box.[仕入れ先コード],Contol_V_m.[仕入れ先名],Box.[着荷],Contol_V_m.顯示器) As TEMP " &
"where 預定日期 >= '2018/07/23' and  預定日期 < '" & date_time1.ToString() & "' and 受入場='" & ddl1.ToString() & "' and (實際到貨時間 is null or 箱數<>已查收 or (箱數=已查收 and DATEDIFF(mi,最後到貨時間,getdate())< 10))) AS TEMP1 left join Exception_handle_time on TEMP1.供應商編號 =Exception_handle_time .供應商編號) left join Exception_view  on Exception_view .異常編號 ='00'+TEMP1.預定日期 +TEMP1 .預定時間 +convert(varchar,TEMP1.箱數)+temp1.供應商編號 where Exception_view .簽核狀態 <>'簽核通過' or Exception_view .簽核狀態 is null " &
"union select * from ((select CASE WHEN LEN(納入時間)=1 then CONVERT(varchar(5),'00:00') WHEN  LEN(納入時間) = 3 THEN CONVERT(varchar(5),'0'+SUBSTRING(納入時間,1,1)+':'+ SUBSTRING(納入時間 ,2,2))WHEN LEN(納入時間)=4 THEN CONVERT(varchar(5),SUBSTRING(納入時間,1,2)+':' + SUBSTRING(納入時間 ,3,2))END  AS 預定時間 ,convert(varchar(16),Contol_V_m.仕入れ先名) AS 供應商,COUNT(Box.[箱数])As 箱數   ,CONVERT (varchar(5),SUBSTRING (着荷,7,2)+':'+SUBSTRING (着荷,9,2)) AS 到貨時間 ,CONVERT (nvarchar,COUNT(Box.[検品]))+ CONVERT (nvarchar, ('/')) + CONVERT(nvarchar,COUNT(Box.[箱数])) AS　點收數,Box.[納入日],CONVERT (varchar (10),'20'+SUBSTRING(納入日,1,2)+'/'+SUBSTRING(納入日,3,2)+'/'+SUBSTRING(納入日,5,2))  As 預定日期,CONVERT (varchar (5),SUBSTRING(納入日,3,2)+'/'+SUBSTRING(納入日,5,2)) As 日期,CONVERT (varchar (19),'20'+SUBSTRING(納入日,1,2)+'-'+SUBSTRING(納入日,3,2)+'-'+SUBSTRING(納入日,5,2))+' '+CASE WHEN LEN(納入時間)=1 then CONVERT(varchar(5),'00:00') WHEN  LEN(納入時間) = 3 THEN CONVERT(varchar(19),'0'+SUBSTRING(納入時間,1,1)+':'+ SUBSTRING(納入時間 ,2,2)+':00')WHEN LEN(納入時間)=4 THEN CONVERT(varchar(19),SUBSTRING(納入時間,1,2)+':' + SUBSTRING(納入時間 ,3,2)+':00')END  AS 預定到貨時間,CONVERT (varchar(19),'20'+SUBSTRING (着荷,1,2)+'-'+SUBSTRING (着荷,3,2)+'-'+SUBSTRING (着荷,5,2)+' '+SUBSTRING (着荷,7,2)+':'+SUBSTRING (着荷,9,2))+':00' AS 實際到貨時間, CASE WHEN LEN(納入時間)=1 then CONVERT(varchar(5),'00:00') WHEN  LEN(納入時間) = 3 THEN CONVERT(varchar(5),'0'+SUBSTRING(納入時間,1,1)+':'+ SUBSTRING(納入時間 ,2,2))WHEN LEN(納入時間)=4 THEN CONVERT(varchar(5),SUBSTRING(納入時間,1,2)+':' + SUBSTRING(納入時間 ,3,2))END  AS 計畫時間,CONVERT (varchar(5),SUBSTRING (着荷,7,2)+':'+SUBSTRING (着荷,9,2)) AS 實際時間,Box.[仕入れ先コード] AS 供應商編號,COUNT(Box.[検品])As 已查收,CONVERT(varchar(19),SUBSTRING(MAX(Box.検品),1,4)+'-'+SUBSTRING(MAX(Box.検品),5,2)+'-'+SUBSTRING(MAX(Box.検品),7,2)+' '+SUBSTRING(MAX(Box.検品),9,2)+':'+SUBSTRING(MAX(Box.検品),11,2)+':'+SUBSTRING(MAX(Box.検品),13,2)) As 最後到貨時間,Contol_V_m.顯示器 AS 受入場 From BOX_Status_Table Box INNER JOIN Contol_V_m ON Box.仕入れ先コード=Contol_V_m.仕入れ先コード " &
"where Box.[納入日] =  '" & date_time.ToString() & "' and Contol_V_m.顯示器='" & ddl1.ToString() & "' group by Box.[納入日],Box.[納入時間],Box.[仕入れ先コード],Contol_V_m.[仕入れ先名],Box.[着荷],Contol_V_m.顯示器 ) AS TEMP2  left join Exception_handle_time on TEMP2.供應商編號 =Exception_handle_time.供應商編號)  left join Exception_view  on Exception_view .異常編號 ='00'+TEMP2.預定日期 +TEMP2 .預定時間 +convert(varchar,TEMP2.箱數)+temp2.供應商編號  " &
"where Exception_view .簽核狀態 <>'簽核通過' or Exception_view .簽核狀態 is NULL order by 預定日期 DESC,預定時間,TEMP1.供應商編號 ASC"


            ds = Db.Get_DataSet(sql)
            'ds.Tables(0).Columns.Add(New DataColumn("no", GetType(String)))
            ds.Tables(0).Columns.Add(New DataColumn("作業預定時間", GetType(String)))
            ds.Tables(0).Columns.Add(New DataColumn("作業完成時間", GetType(String)))
            ds.Tables(0).Columns.Add(New DataColumn("到貨異常", GetType(String)))
            ds.Tables(0).Columns.Add(New DataColumn("時間異常", GetType(String)))
            Dim dr As DataRow
            Dim dr2 As DataRow

            Dim sql2 As String =
"select * from ((select * from (select  CASE WHEN LEN(納入時間)=1 then CONVERT(varchar(5),'00:00') WHEN  LEN(納入時間) = 3 THEN CONVERT(varchar(5),'0'+SUBSTRING(納入時間,1,1)+':'+ SUBSTRING(納入時間 ,2,2))WHEN LEN(納入時間)=4 THEN CONVERT(varchar(5),SUBSTRING(納入時間,1,2)+':' + SUBSTRING(納入時間 ,3,2))END  AS 預定時間 ,convert(varchar(16),Contol_V_m.仕入れ先名) AS 供應商,COUNT(Box.[箱数])As 箱數   ,CONVERT (varchar(5),SUBSTRING (着荷,7,2)+':'+SUBSTRING (着荷,9,2)) AS 到貨時間 ,CONVERT (nvarchar,COUNT(Box.[検品]))+ CONVERT (nvarchar, ('/')) + CONVERT(nvarchar,COUNT(Box.[箱数])) AS　點收數,Box.[納入日],CONVERT (varchar (10),'20'+SUBSTRING(納入日,1,2)+'/'+SUBSTRING(納入日,3,2)+'/'+SUBSTRING(納入日,5,2))  As 預定日期,CONVERT (varchar (5),SUBSTRING(納入日,3,2)+'/'+SUBSTRING(納入日,5,2)) As 日期,CONVERT (varchar (19),'20'+SUBSTRING(納入日,1,2)+'-'+SUBSTRING(納入日,3,2)+'-'+SUBSTRING(納入日,5,2))+' '+CASE WHEN LEN(納入時間)=1 then CONVERT(varchar(5),'00:00') WHEN  LEN(納入時間) = 3 THEN CONVERT(varchar(19),'0'+SUBSTRING(納入時間,1,1)+':'+ SUBSTRING(納入時間 ,2,2)+':00')WHEN LEN(納入時間)=4 THEN CONVERT(varchar(19),SUBSTRING(納入時間,1,2)+':' + SUBSTRING(納入時間 ,3,2)+':00')END  AS 預定到貨時間,CONVERT (varchar(19),'20'+SUBSTRING (着荷,1,2)+'-'+SUBSTRING (着荷,3,2)+'-'+SUBSTRING (着荷,5,2)+' '+SUBSTRING (着荷,7,2)+':'+SUBSTRING (着荷,9,2))+':00' AS 實際到貨時間,CASE WHEN LEN(納入時間)=1 then CONVERT(varchar(5),'00:00') WHEN  LEN(納入時間) = 3 THEN CONVERT(varchar(5),'0'+SUBSTRING(納入時間,1,1)+':'+ SUBSTRING(納入時間 ,2,2))WHEN LEN(納入時間)=4 THEN CONVERT(varchar(5),SUBSTRING(納入時間,1,2)+':' + SUBSTRING(納入時間 ,3,2))END  AS 計畫時間,CONVERT (varchar(5),SUBSTRING (着荷,7,2)+':'+SUBSTRING (着荷,9,2)) AS 實際時間,Box.[仕入れ先コード] AS 供應商編號,COUNT(Box.[検品])As 已查收,CONVERT(varchar(19),SUBSTRING(MAX(Box.検品),1,4)+'-'+SUBSTRING(MAX(Box.検品),5,2)+'-'+SUBSTRING(MAX(Box.検品),7,2)+' '+SUBSTRING(MAX(Box.検品),9,2)+':'+SUBSTRING(MAX(Box.検品),11,2)+':'+SUBSTRING(MAX(Box.検品),13,2)) As 最後到貨時間,Contol_V_m.顯示器 AS 受入場 From BOX_Status_Table Box INNER JOIN Contol_V_m ON Box.仕入れ先コード=Contol_V_m.仕入れ先コード group by Box.[納入日],Box.納入時間,Box.[仕入れ先コード],Contol_V_m.[仕入れ先名],Box.[着荷],Contol_V_m.顯示器) As TEMP " &
"where 預定日期 >= '2018/07/23' and  預定日期 < '" & date_time1.ToString() & "' and 受入場='" & ddl1.ToString() & "' and  (實際到貨時間 is null or 箱數<>已查收 or (箱數=已查收 and DATEDIFF(mi,最後到貨時間,getdate())< 10))) AS　TEMP1  left join Exception_view  on  Exception_view.異常編號='01'+TEMP1.預定日期 +TEMP1 .預定時間 +convert(varchar,TEMP1.箱數)+temp1.供應商編號 ) left join Exception_review_pass EVP on TEMP1.預定日期 =EVP.預定日期 and TEMP1.預定時間 =EVP.預定時間  and TEMP1.箱數 =EVP.箱數  and TEMP1.供應商編號 =EVP.供應商編號  " &
"where ( EVP.預定日期 is NULL and EVP.預定時間 is null and EVP.箱數 is null and EVP.供應商編號  is NULL )or( TEMP1.預定日期 <>EVP.預定日期 and TEMP1.預定時間 <>EVP.預定時間  and TEMP1.箱數 <>EVP.箱數  and TEMP1.供應商編號 <> EVP.供應商編號)  " &
"union select * from ((select  CASE WHEN LEN(納入時間)=1 then CONVERT(varchar(5),'00:00') WHEN  LEN(納入時間) = 3 THEN CONVERT(varchar(5),'0'+SUBSTRING(納入時間,1,1)+':'+ SUBSTRING(納入時間 ,2,2))WHEN LEN(納入時間)=4 THEN CONVERT(varchar(5),SUBSTRING(納入時間,1,2)+':' + SUBSTRING(納入時間 ,3,2))END  AS 預定時間 ,convert(varchar(16),Contol_V_m.仕入れ先名) AS 供應商,COUNT(Box.[箱数])As 箱數   ,CONVERT (varchar(5),SUBSTRING (着荷,7,2)+':'+SUBSTRING (着荷,9,2)) AS 到貨時間 ,CONVERT (nvarchar,COUNT(Box.[検品]))+ CONVERT (nvarchar, ('/')) + CONVERT(nvarchar,COUNT(Box.[箱数])) AS　點收數,Box.[納入日],CONVERT (varchar (10),'20'+SUBSTRING(納入日,1,2)+'/'+SUBSTRING(納入日,3,2)+'/'+SUBSTRING(納入日,5,2))  As 預定日期,CONVERT (varchar (5),SUBSTRING(納入日,3,2)+'/'+SUBSTRING(納入日,5,2)) As 日期,CONVERT (varchar (19),'20'+SUBSTRING(納入日,1,2)+'-'+SUBSTRING(納入日,3,2)+'-'+SUBSTRING(納入日,5,2))+' '+CASE WHEN LEN(納入時間)=1 then CONVERT(varchar(5),'00:00') WHEN  LEN(納入時間) = 3 THEN CONVERT(varchar(19),'0'+SUBSTRING(納入時間,1,1)+':'+ SUBSTRING(納入時間 ,2,2)+':00')WHEN LEN(納入時間)=4 THEN CONVERT(varchar(19),SUBSTRING(納入時間,1,2)+':' + SUBSTRING(納入時間 ,3,2)+':00')END  AS 預定到貨時間,CONVERT (varchar(19),'20'+SUBSTRING (着荷,1,2)+'-'+SUBSTRING (着荷,3,2)+'-'+SUBSTRING (着荷,5,2)+' '+SUBSTRING (着荷,7,2)+':'+SUBSTRING (着荷,9,2))+':00' AS 實際到貨時間, CASE WHEN LEN(納入時間)=1 then CONVERT(varchar(5),'00:00') WHEN  LEN(納入時間) = 3 THEN CONVERT(varchar(5),'0'+SUBSTRING(納入時間,1,1)+':'+ SUBSTRING(納入時間 ,2,2))WHEN LEN(納入時間)=4 THEN CONVERT(varchar(5),SUBSTRING(納入時間,1,2)+':' + SUBSTRING(納入時間 ,3,2))END  AS 計畫時間,CONVERT (varchar(5),SUBSTRING (着荷,7,2)+':'+SUBSTRING (着荷,9,2)) AS 實際時間,Box.[仕入れ先コード] AS 供應商編號,COUNT(Box.[検品])As 已查收,CONVERT(varchar(19),SUBSTRING(MAX(Box.検品),1,4)+'-'+SUBSTRING(MAX(Box.検品),5,2)+'-'+SUBSTRING(MAX(Box.検品),7,2)+' '+SUBSTRING(MAX(Box.検品),9,2)+':'+SUBSTRING(MAX(Box.検品),11,2)+':'+SUBSTRING(MAX(Box.検品),13,2)) As 最後到貨時間,Contol_V_m.顯示器 AS 受入場 From BOX_Status_Table Box INNER JOIN Contol_V_m ON Box.仕入れ先コード=Contol_V_m.仕入れ先コード " &
"where Box.[納入日] = '" & date_time.ToString() & "' and Contol_V_m.顯示器='" & ddl1.ToString() & "' group by Box.[納入日],Box.[納入時間],Box.[仕入れ先コード],Contol_V_m.[仕入れ先名],Box.[着荷],Contol_V_m.顯示器) AS TEMP2  left join Exception_view on Exception_view.異常編號='01'+TEMP2.預定日期 +TEMP2 .預定時間 +convert(varchar,TEMP2.箱數)+temp2.供應商編號)  left join Exception_review_pass EVP on TEMP2.預定日期 =EVP.預定日期 and TEMP2.預定時間 =EVP.預定時間  and TEMP2.箱數 =EVP.箱數  and TEMP2.供應商編號 =EVP.供應商編號 where ( EVP.預定日期 is NULL and EVP.預定時間 is null and EVP.箱數 is null and EVP.供應商編號  is NULL )or( TEMP2.預定日期 <>EVP.預定日期 and TEMP2.預定時間 <>EVP.預定時間  and TEMP2.箱數 <>EVP.箱數  and TEMP2.供應商編號 <> EVP.供應商編號) order by TEMP1.預定日期 DESC , TEMP1.預定時間 ASC,TEMP1.供應商編號 ASC"
            ds2 = Db.Get_DataSet(sql2)

            Dim arr As String() = New String() {"A03", "A06", "A07", "A15", "A20", "A21", "A22", "A45", "A54", "A55", "A56", "A63", "A76", "A94", "A99", "F03", "F08", "F09", "F10", "F15", "F18", "F19", "F20", "F21", "F25", "F28", "F30", "F31", "F34", "F38", "F44", "F45", "F47", "F52", "F64"}
            For k As Integer = ds.Tables(0).Rows.Count - 1 To 0 Step -1
                dr = ds.Tables(0).Rows(k)
                For k1 As Integer = arr.Count - 1 To 0 Step -1
                    If dr("供應商編號").ToString() = arr(k1) Then
                        ds.Tables(0).Rows.RemoveAt(k)
                        ds2.Tables(0).Rows.RemoveAt(k)
                        Exit For
                    End If
                Next
            Next

            For k As Integer = 0 To ds.Tables(0).Rows.Count - 1

                dr = ds.Tables(0).Rows(k)
                dr2 = ds2.Tables(0).Rows(k)

                dr("no") = k + 1
                dr("到貨異常") = dr("status")
                dr("時間異常") = dr2("status")
            Next
            GridView1.DataSource = ds.Tables(0)
            GridView1.DataBind()
            change_color()
            change_color1()
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
    Private Sub change_color() '到貨時間異常 反橘 寄信
        Try
            For k As Integer = 0 To ds.Tables(0).Rows.Count() - 1
                Dim dr As DataRow = ds.Tables(0).Rows(k)
                Dim time1 As DateTime = time.ToString("yyyy-MM-dd HH:mm:ss")
                Dim time2 As DateTime = dr("預定到貨時間").ToString()
                If time1 > time2.AddMinutes(30) And dr("到貨時間") Is DBNull.Value Then  '現在時間>應到時間+30分鐘 貨未到
                    Me.GridView1.Rows(k).BackColor = Color.FromArgb(255, 192, 128)

                    Dim sql1 As String = "select 異常編號 from Exception_view where 異常編號='00'+'" & dr("預定日期").ToString() & "'+'" & dr("預定時間").ToString() & "'+'" & dr("箱數").ToString() & "'+'" & dr("供應商編號").ToString() & "'"
                    ds1 = Db.Get_DataSet(sql1)
                    If ds1.Tables(0).Rows.Count = 0 Then
                        Dim sql2 As String = "insert into Exception_view (異常編號,異常日期,異常種類,異常對象,計畫時間,實際時間,異常調查原因,再發防止,責任部屬,簽核狀態,受入場,send_mail,status,modify1,modify2,modify_reason1,modify_reason2) values('00'+'" & dr("預定日期").ToString() & "'+'" & dr("預定時間").ToString() & "'+'" & dr("箱數").ToString() & "'+'" & dr("供應商編號").ToString() & "','" & dr("預定日期") & "','到貨時間異常','" & dr("供應商") & "','" & dr("計畫時間") & "','" & dr("實際時間") & "','','','','填寫中','" & dr("受入場") & "','0','楊琇雯',0,0,'','')"
                        ds2 = Db.Get_DataSet(sql2)
                    End If

                    Dim sql6 As String = "select send_mail from Exception_view where 異常編號 ='00'+'" & dr("預定日期").ToString() & "'+'" & dr("預定時間").ToString() & "'+'" & dr("箱數").ToString() & "'+'" & dr("供應商編號").ToString() & "'"
                    ds6 = Db.Get_DataSet(sql6)
                    Dim dr3 As DataRow = ds6.Tables(0).Rows(0)

                    If ds6.Tables(0).Rows.Count > 0 Then
                        If dr3("send_mail") = 0 Then

                            Dim number As String = "00" & dr("預定日期").ToString() & dr("預定時間").ToString() & dr("箱數").ToString() & dr("供應商編號").ToString()
                            Dim company As String = dr("供應商") + "到貨時間異常"

                            If dr("供應商編號") = "F11" Or dr("供應商編號") = "F12" Or dr("供應商編號") = "F27" Or dr("供應商編號") = "F32" Or dr("供應商編號") = "F35" Or dr("供應商編號") = "F54" Or dr("供應商編號") = "F55" Or dr("供應商編號") = "F56" Or dr("供應商編號") = "F57" Or dr("供應商編號") = "F58" Or dr("供應商編號") = "F59" Or dr("供應商編號") = "F60" Then
                                Dim sql8 As String = "select EL.user_id,user_dept,EL.user_name ,user_position ,user_mail,user_group ,Exception_LxP .permission  from Exception_Login EL inner join Exception_LxP on Exception_LxP.user_id =EL.user_id   where  permission= '第一接收者2' order by user_id ASC"
                                ds8 = Db.Get_DataSet(sql8)
                                Dim user_all As String = ""
                                If ds8.Tables(0).Rows.Count > 0 Then
                                    For i As Integer = 0 To ds8.Tables(0).Rows.Count() - 1
                                        Dim dr1 As DataRow = ds8.Tables(0).Rows(i)
                                        Dim user_mail1 As String = dr1("user_mail").ToString()
                                        user_all = user_all & dr1("user_mail") & ","
                                    Next
                                End If
                                Dim user_all1 As String = user_all.Substring(0, user_all.Length() - 1)

                                Dim sql5 As String = "select EL.user_id,user_dept,EL.user_name ,user_position ,user_mail,user_group ,Exception_LxP .permission  from Exception_Login EL inner join Exception_LxP on Exception_LxP.user_id =EL.user_id   where  permission= 'CC2' order by user_id ASC"
                                ds5 = Db.Get_DataSet(sql5)
                                Dim user_CCall As String = ""
                                If ds5.Tables(0).Rows.Count > 0 Then
                                    For i As Integer = 0 To ds5.Tables(0).Rows.Count() - 1
                                        Dim dr2 As DataRow = ds5.Tables(0).Rows(i)
                                        Dim user_mail2 As String = dr2("user_mail").ToString()
                                        user_CCall = user_CCall & dr2("user_mail") & ","
                                    Next
                                End If
                                Dim user_CCall1 As String = user_CCall.Substring(0, user_CCall.Length() - 1)
                                mail.send_mail1("" & user_all1 & "", "" & user_CCall1 & "", company, number)

                            Else
                                Dim sql4 As String = "select EL.user_id,user_dept,EL.user_name ,user_position ,user_mail,user_group ,Exception_LxP .permission  from Exception_Login EL inner join Exception_LxP on Exception_LxP.user_id =EL.user_id   where  permission= '第一接收者1' order by user_id ASC"
                                ds4 = Db.Get_DataSet(sql4)
                                Dim user_all As String = ""
                                If ds4.Tables(0).Rows.Count > 0 Then
                                    For i As Integer = 0 To ds4.Tables(0).Rows.Count() - 1
                                        Dim dr1 As DataRow = ds4.Tables(0).Rows(i)
                                        Dim user_mail1 As String = dr1("user_mail").ToString()
                                        user_all = user_all & dr1("user_mail") & ","
                                    Next
                                End If
                                Dim user_all1 As String = user_all.Substring(0, user_all.Length() - 1)


                                Dim sql5 As String = "select EL.user_id,user_dept,EL.user_name ,user_position ,user_mail,user_group ,Exception_LxP .permission  from Exception_Login EL inner join Exception_LxP on Exception_LxP.user_id =EL.user_id   where  permission= 'CC1' order by user_id ASC"
                                ds5 = Db.Get_DataSet(sql5)
                                Dim user_CCall As String = ""
                                If ds5.Tables(0).Rows.Count > 0 Then
                                    For i As Integer = 0 To ds5.Tables(0).Rows.Count() - 1
                                        Dim dr2 As DataRow = ds5.Tables(0).Rows(i)
                                        Dim user_mail2 As String = dr2("user_mail").ToString()
                                        user_CCall = user_CCall & dr2("user_mail") & ","
                                    Next
                                End If
                                Dim user_CCall1 As String = user_CCall.Substring(0, user_CCall.Length() - 1)
                                mail.send_mail1("" & user_all1 & "", "" & user_CCall1 & "", company, number)
                            End If

                            Dim sql7 As String = "update Exception_view set send_mail ='1' where 異常編號 ='00'+'" & dr("預定日期").ToString() & "'+'" & dr("預定時間").ToString() & "'+'" & dr("箱數").ToString() & "'+'" & dr("供應商編號").ToString() & "'"
                            ds7 = Db.Get_DataSet(sql7)
                        End If
                    End If
                End If



                If Not dr("實際到貨時間") Is DBNull.Value Then  '到貨時間>or<預定時間 30分鐘 (不準時)
                    Dim time3 As DateTime = dr("實際到貨時間").ToString()
                    If time3 > time2.AddMinutes(30) Or time3 < time2.AddMinutes(-30) Then
                        Me.GridView1.Rows(k).BackColor = Color.FromArgb(255, 192, 128)

                        Dim sql1 As String = "select 異常編號, send_mail from Exception_view where 異常編號='00'+'" & dr("預定日期").ToString() & "'+'" & dr("預定時間").ToString() & "'+'" & dr("箱數").ToString() & "'+'" & dr("供應商編號").ToString() & "'"
                        ds1 = Db.Get_DataSet(sql1)
                        Dim dr3 As DataRow = ds1.Tables(0).Rows(0)
                        If ds1.Tables(0).Rows.Count = 0 Then
                            Dim sql2 As String = "insert into Exception_view (異常編號,異常日期,異常種類,異常對象,計畫時間,實際時間,異常調查原因,再發防止,責任部屬,簽核狀態,受入場,send_mail,status,modify1,modify2,modify_reason1,modify_reason2) values('00'+'" & dr("預定日期").ToString() & "'+'" & dr("預定時間").ToString() & "'+'" & dr("箱數").ToString() & "'+'" & dr("供應商編號").ToString() & "','" & dr("預定日期") & "','到貨時間異常','" & dr("供應商") & "','" & dr("計畫時間") & "','" & dr("實際時間") & "','','','','填寫中','" & dr("受入場") & "','0','楊琇雯',0,0,'','')"
                            ds2 = Db.Get_DataSet(sql2)

                            '寄信
                            Dim number As String = "00" & dr("預定日期").ToString() & dr("預定時間").ToString() & dr("箱數").ToString() & dr("供應商編號").ToString()
                            Dim company As String = dr("供應商") + "到貨時間異常"

                            If dr("供應商編號") = "F11" Or dr("供應商編號") = "F12" Or dr("供應商編號") = "F27" Or dr("供應商編號") = "F32" Or dr("供應商編號") = "F35" Or dr("供應商編號") = "F54" Or dr("供應商編號") = "F55" Or dr("供應商編號") = "F56" Or dr("供應商編號") = "F57" Or dr("供應商編號") = "F58" Or dr("供應商編號") = "F59" Or dr("供應商編號") = "F60" Then
                                Dim sql8 As String = "select EL.user_id,user_dept,EL.user_name ,user_position ,user_mail,user_group ,Exception_LxP .permission  from Exception_Login EL inner join Exception_LxP on Exception_LxP.user_id =EL.user_id   where  permission= '第一接收者2' order by user_id ASC"
                                ds8 = Db.Get_DataSet(sql8)
                                Dim user_all As String = ""
                                If ds8.Tables(0).Rows.Count > 0 Then
                                    For i As Integer = 0 To ds8.Tables(0).Rows.Count() - 1
                                        Dim dr1 As DataRow = ds8.Tables(0).Rows(i)
                                        Dim user_mail1 As String = dr1("user_mail").ToString()
                                        user_all = user_all & dr1("user_mail") & ","
                                    Next
                                End If
                                Dim user_all1 As String = user_all.Substring(0, user_all.Length() - 1)

                                Dim sql5 As String = "select EL.user_id,user_dept,EL.user_name ,user_position ,user_mail,user_group ,Exception_LxP .permission  from Exception_Login EL inner join Exception_LxP on Exception_LxP.user_id =EL.user_id   where  permission= 'CC2' order by user_id ASC"
                                ds5 = Db.Get_DataSet(sql5)
                                Dim user_CCall As String = ""
                                If ds5.Tables(0).Rows.Count > 0 Then
                                    For i As Integer = 0 To ds5.Tables(0).Rows.Count() - 1
                                        Dim dr2 As DataRow = ds5.Tables(0).Rows(i)
                                        Dim user_mail2 As String = dr2("user_mail").ToString()
                                        user_CCall = user_CCall & dr2("user_mail") & ","
                                    Next
                                End If
                                Dim user_CCall1 As String = user_CCall.Substring(0, user_CCall.Length() - 1)
                                mail.send_mail1("" & user_all1 & "", "" & user_CCall1 & "", company, number)

                            Else
                                Dim sql4 As String = "select EL.user_id,user_dept,EL.user_name ,user_position ,user_mail,user_group ,Exception_LxP .permission  from Exception_Login EL inner join Exception_LxP on Exception_LxP.user_id =EL.user_id   where  permission= '第一接收者1' order by user_id ASC"
                                ds4 = Db.Get_DataSet(sql4)
                                Dim user_all As String = ""
                                If ds4.Tables(0).Rows.Count > 0 Then
                                    For i As Integer = 0 To ds4.Tables(0).Rows.Count() - 1
                                        Dim dr1 As DataRow = ds4.Tables(0).Rows(i)
                                        Dim user_mail1 As String = dr1("user_mail").ToString()
                                        user_all = user_all & dr1("user_mail") & ","
                                    Next
                                End If
                                Dim user_all1 As String = user_all.Substring(0, user_all.Length() - 1)


                                Dim sql5 As String = "select EL.user_id,user_dept,EL.user_name ,user_position ,user_mail,user_group ,Exception_LxP .permission  from Exception_Login EL inner join Exception_LxP on Exception_LxP.user_id =EL.user_id   where  permission= 'CC1' order by user_id ASC"
                                ds5 = Db.Get_DataSet(sql5)
                                Dim user_CCall As String = ""
                                If ds5.Tables(0).Rows.Count > 0 Then
                                    For i As Integer = 0 To ds5.Tables(0).Rows.Count() - 1
                                        Dim dr2 As DataRow = ds5.Tables(0).Rows(i)
                                        Dim user_mail2 As String = dr2("user_mail").ToString()
                                        user_CCall = user_CCall & dr2("user_mail") & ","
                                    Next
                                End If
                                Dim user_CCall1 As String = user_CCall.Substring(0, user_CCall.Length() - 1)
                                mail.send_mail1("" & user_all1 & "", "" & user_CCall1 & "", company, number)

                            End If

                            Dim sql7 As String = "update Exception_view set send_mail ='1' where 異常編號 ='00'+'" & dr("預定日期").ToString() & "'+'" & dr("預定時間").ToString() & "'+'" & dr("箱數").ToString() & "'+'" & dr("供應商編號").ToString() & "'"
                            ds7 = Db.Get_DataSet(sql7)


                        ElseIf ds1.Tables(0).Rows.Count > 0 And dr("實際時間") Is DBNull.Value Then
                            Dim sql8 As String = "update Exception_view set 實際時間='" & dr("實際時間") & "'  where 異常編號 ='00'+'" & dr("預定日期").ToString() & "'+'" & dr("預定時間").ToString() & "'+'" & dr("箱數").ToString() & "'+'" & dr("供應商編號").ToString() & "'"
                            ds8 = Db.Get_DataSet(sql8)
                            If dr3("send_mail") = 0 Then
                                Dim number As String = "00" & dr("預定日期").ToString() & dr("預定時間").ToString() & dr("箱數").ToString() & dr("供應商編號").ToString()
                                Dim company As String = dr("供應商") + "到貨時間異常"

                                If dr("供應商編號") = "F11" Or dr("供應商編號") = "F12" Or dr("供應商編號") = "F27" Or dr("供應商編號") = "F32" Or dr("供應商編號") = "F35" Or dr("供應商編號") = "F54" Or dr("供應商編號") = "F55" Or dr("供應商編號") = "F56" Or dr("供應商編號") = "F57" Or dr("供應商編號") = "F58" Or dr("供應商編號") = "F59" Or dr("供應商編號") = "F60" Then
                                    Dim sql9 As String = "select EL.user_id,user_dept,EL.user_name ,user_position ,user_mail,user_group ,Exception_LxP .permission  from Exception_Login EL inner join Exception_LxP on Exception_LxP.user_id =EL.user_id   where  permission= '第一接收者2' order by user_id ASC"
                                    ds9 = Db.Get_DataSet(sql9)
                                    Dim user_all As String = ""
                                    If ds9.Tables(0).Rows.Count > 0 Then
                                        For i As Integer = 0 To ds9.Tables(0).Rows.Count() - 1
                                            Dim dr1 As DataRow = ds9.Tables(0).Rows(i)
                                            Dim user_mail1 As String = dr1("user_mail").ToString()
                                            user_all = user_all & dr1("user_mail") & ","
                                        Next
                                    End If
                                    Dim user_all1 As String = user_all.Substring(0, user_all.Length() - 1)

                                    Dim sql5 As String = "select EL.user_id,user_dept,EL.user_name ,user_position ,user_mail,user_group ,Exception_LxP .permission  from Exception_Login EL inner join Exception_LxP on Exception_LxP.user_id =EL.user_id   where  permission= 'CC2' order by user_id ASC"
                                    ds5 = Db.Get_DataSet(sql5)
                                    Dim user_CCall As String = ""
                                    If ds5.Tables(0).Rows.Count > 0 Then
                                        For i As Integer = 0 To ds5.Tables(0).Rows.Count() - 1
                                            Dim dr2 As DataRow = ds5.Tables(0).Rows(i)
                                            Dim user_mail2 As String = dr2("user_mail").ToString()
                                            user_CCall = user_CCall & dr2("user_mail") & ","
                                        Next
                                    End If
                                    Dim user_CCall1 As String = user_CCall.Substring(0, user_CCall.Length() - 1)
                                    mail.send_mail1("" & user_all1 & "", "" & user_CCall1 & "", company, number)

                                Else
                                    Dim sql4 As String = "select EL.user_id,user_dept,EL.user_name ,user_position ,user_mail,user_group ,Exception_LxP .permission  from Exception_Login EL inner join Exception_LxP on Exception_LxP.user_id =EL.user_id   where  permission= '第一接收者1' order by user_id ASC"
                                    ds4 = Db.Get_DataSet(sql4)
                                    Dim user_all As String = ""
                                    If ds4.Tables(0).Rows.Count > 0 Then
                                        For i As Integer = 0 To ds4.Tables(0).Rows.Count() - 1
                                            Dim dr1 As DataRow = ds4.Tables(0).Rows(i)
                                            Dim user_mail1 As String = dr1("user_mail").ToString()
                                            user_all = user_all & dr1("user_mail") & ","
                                        Next
                                    End If
                                    Dim user_all1 As String = user_all.Substring(0, user_all.Length() - 1)


                                    Dim sql5 As String = "select EL.user_id,user_dept,EL.user_name ,user_position ,user_mail,user_group ,Exception_LxP .permission  from Exception_Login EL inner join Exception_LxP on Exception_LxP.user_id =EL.user_id   where  permission= 'CC1' order by user_id ASC"
                                    ds5 = Db.Get_DataSet(sql5)
                                    Dim user_CCall As String = ""
                                    If ds5.Tables(0).Rows.Count > 0 Then
                                        For i As Integer = 0 To ds5.Tables(0).Rows.Count() - 1
                                            Dim dr2 As DataRow = ds5.Tables(0).Rows(i)
                                            Dim user_mail2 As String = dr2("user_mail").ToString()
                                            user_CCall = user_CCall & dr2("user_mail") & ","
                                        Next
                                    End If
                                    Dim user_CCall1 As String = user_CCall.Substring(0, user_CCall.Length() - 1)
                                    mail.send_mail1("" & user_all1 & "", "" & user_CCall1 & "", company, number)

                                End If

                                Dim sql7 As String = "update Exception_view set send_mail ='1' where 異常編號 ='00'+'" & dr("預定日期").ToString() & "'+'" & dr("預定時間").ToString() & "'+'" & dr("箱數").ToString() & "'+'" & dr("供應商編號").ToString() & "'"
                                ds7 = Db.Get_DataSet(sql7)
                            End If
                        End If
                    End If
                End If
            Next
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
    Private Sub change_color1()  '進貨速度過慢或缺貨 (作業時間異常)
        Try
            For k As Integer = 0 To ds.Tables(0).Rows.Count() - 1
                Dim dr As DataRow = ds.Tables(0).Rows(k)
                If Not dr("實際到貨時間") Is DBNull.Value Then
                    Dim time1 As DateTime = time.ToString("yyyy-MM-dd HH:mm:ss")
                    Dim time2 As DateTime = dr("實際到貨時間").ToString()
                    Dim thing As Integer = dr("箱數").ToString()         '箱數
                    Dim thing_time As Integer = 0
                    Dim handle_time As Integer = dr("handle_time")
                    thing_time = handle_time + ((thing * 3 * 1.5) / 60) '卸貨時間(分)
                    If ((thing * 3 * 1.5) / 60) > thing_time Then
                        thing_time = thing_time + 1
                    End If
                    Dim dateline As DateTime = time2.AddMinutes(thing_time)       '預計應點收完時間
                        Dim dateline1 As String = dateline.ToString("yyyy-MM-dd HH:mm:ss")

                        If time1 > dateline1 And dr("箱數") <> dr("已查收") Then
                            Me.GridView1.Rows(k).BackColor = Color.LightCoral

                            Dim sql1 As String = "select 異常編號 from Exception_view where 異常編號='01'+'" & dr("預定日期").ToString() & "'+'" & dr("預定時間").ToString() & "'+'" & dr("箱數").ToString() & "'+'" & dr("供應商編號").ToString() & "'"
                            ds1 = Db.Get_DataSet(sql1)
                            If ds1.Tables(0).Rows.Count = 0 Then
                                If dr("箱數") = dr("已查收") Then
                                    Dim a As DateTime = dr("最後到貨時間").ToString()
                                    Dim sql2 As String = "insert into Exception_view (異常編號,異常日期,異常種類,異常對象,計畫時間,實際時間,異常調查原因,再發防止,責任部屬,簽核狀態,受入場,send_mail,status,modify1,modify2,modify_reason1,modify_reason2) values('01'+'" & dr("預定日期").ToString() & "'+'" & dr("預定時間").ToString() & "'+'" & dr("箱數").ToString() & "'+'" & dr("供應商編號").ToString() & "','" & dr("預定日期") & "','作業時間異常','" & dr("供應商") & "','" & dateline.ToString("HH:mm") & "','" & a.ToString("HH:mm") & "','','','','填寫中','" & dr("受入場") & "','0','楊琇雯',0,0,'','')"
                                    ds2 = Db.Get_DataSet(sql2)
                                ElseIf dr("箱數") <> dr("已查收") Then
                                    Dim a As String = ""
                                    Dim sql2 As String = "insert into Exception_view (異常編號,異常日期,異常種類,異常對象,計畫時間,實際時間,異常調查原因,再發防止,責任部屬,簽核狀態,受入場,send_mail,status,modify1,modify2,modify_reason1,modify_reason2) values('01'+'" & dr("預定日期").ToString() & "'+'" & dr("預定時間").ToString() & "'+'" & dr("箱數").ToString() & "'+'" & dr("供應商編號").ToString() & "','" & dr("預定日期") & "','作業時間異常','" & dr("供應商") & "','" & dateline.ToString("HH:mm") & "','" & a.ToString() & "','','','','填寫中','" & dr("受入場") & "','0','楊琇雯',0,0,'','')"
                                    ds2 = Db.Get_DataSet(sql2)
                            End If
                        End If
                            Dim sql6 As String = "select send_mail from Exception_view where 異常編號 ='01'+'" & dr("預定日期").ToString() & "'+'" & dr("預定時間").ToString() & "'+'" & dr("箱數").ToString() & "'+'" & dr("供應商編號").ToString() & "'"
                            ds6 = Db.Get_DataSet(sql6)
                            Dim dr3 As DataRow = ds6.Tables(0).Rows(0)

                            If ds6.Tables(0).Rows.Count > 0 Then
                                If dr3("send_mail") = 0 Then

                                    Dim number As String = "01" & dr("預定日期").ToString() & dr("預定時間").ToString() & dr("箱數").ToString() & dr("供應商編號").ToString()
                                    Dim company As String = dr("供應商") + "點收作業時間異常"

                                    If dr("供應商編號") = "F11" Or dr("供應商編號") = "F12" Or dr("供應商編號") = "F27" Or dr("供應商編號") = "F32" Or dr("供應商編號") = "F35" Or dr("供應商編號") = "F54" Or dr("供應商編號") = "F55" Or dr("供應商編號") = "F56" Or dr("供應商編號") = "F57" Or dr("供應商編號") = "F58" Or dr("供應商編號") = "F59" Or dr("供應商編號") = "F60" Then
                                        Dim sql8 As String = "select EL.user_id,user_dept,EL.user_name ,user_position ,user_mail,user_group ,Exception_LxP .permission  from Exception_Login EL inner join Exception_LxP on Exception_LxP.user_id =EL.user_id   where  permission= '第一接收者2' order by user_id ASC"
                                        ds8 = Db.Get_DataSet(sql8)
                                        Dim user_all As String = ""
                                        If ds8.Tables(0).Rows.Count > 0 Then
                                            For i As Integer = 0 To ds8.Tables(0).Rows.Count() - 1
                                                Dim dr1 As DataRow = ds8.Tables(0).Rows(i)
                                                Dim user_mail1 As String = dr1("user_mail").ToString()
                                                user_all = user_all & dr1("user_mail") & ","
                                            Next
                                        End If
                                        Dim user_all1 As String = user_all.Substring(0, user_all.Length() - 1)

                                        Dim sql5 As String = "select EL.user_id,user_dept,EL.user_name ,user_position ,user_mail,user_group ,Exception_LxP .permission  from Exception_Login EL inner join Exception_LxP on Exception_LxP.user_id =EL.user_id   where  permission= 'CC2' order by user_id ASC"
                                        ds5 = Db.Get_DataSet(sql5)
                                        Dim user_CCall As String = ""
                                        If ds5.Tables(0).Rows.Count > 0 Then
                                            For i As Integer = 0 To ds5.Tables(0).Rows.Count() - 1
                                                Dim dr2 As DataRow = ds5.Tables(0).Rows(i)
                                                Dim user_mail2 As String = dr2("user_mail").ToString()
                                                user_CCall = user_CCall & dr2("user_mail") & ","
                                            Next
                                        End If
                                        Dim user_CCall1 As String = user_CCall.Substring(0, user_CCall.Length() - 1)
                                        mail.send_mail1("" & user_all1 & "", "" & user_CCall1 & "", company, number)

                                    Else
                                        Dim sql4 As String = "select EL.user_id,user_dept,EL.user_name ,user_position ,user_mail,user_group ,Exception_LxP .permission  from Exception_Login EL inner join Exception_LxP on Exception_LxP.user_id =EL.user_id   where  permission= '第一接收者1' order by user_id ASC"
                                        ds4 = Db.Get_DataSet(sql4)
                                        Dim user_all As String = ""
                                        If ds4.Tables(0).Rows.Count > 0 Then
                                            For i As Integer = 0 To ds4.Tables(0).Rows.Count() - 1
                                                Dim dr1 As DataRow = ds4.Tables(0).Rows(i)
                                                Dim user_mail1 As String = dr1("user_mail").ToString()
                                                user_all = user_all & dr1("user_mail") & ","
                                            Next
                                        End If
                                        Dim user_all1 As String = user_all.Substring(0, user_all.Length() - 1)


                                        Dim sql5 As String = "select EL.user_id,user_dept,EL.user_name ,user_position ,user_mail,user_group ,Exception_LxP .permission  from Exception_Login EL inner join Exception_LxP on Exception_LxP.user_id =EL.user_id   where  permission= 'CC1' order by user_id ASC"
                                        ds5 = Db.Get_DataSet(sql5)
                                        Dim user_CCall As String = ""
                                        If ds5.Tables(0).Rows.Count > 0 Then
                                            For i As Integer = 0 To ds5.Tables(0).Rows.Count() - 1
                                                Dim dr2 As DataRow = ds5.Tables(0).Rows(i)
                                                Dim user_mail2 As String = dr2("user_mail").ToString()
                                                user_CCall = user_CCall & dr2("user_mail") & ","
                                            Next
                                        End If
                                        Dim user_CCall1 As String = user_CCall.Substring(0, user_CCall.Length() - 1)
                                        mail.send_mail1("" & user_all1 & "", "" & user_CCall1 & "", company, number)

                                    End If

                                    Dim sql7 As String = "update Exception_view set send_mail ='1' where 異常編號 ='01'+'" & dr("預定日期").ToString() & "'+'" & dr("預定時間").ToString() & "'+'" & dr("箱數").ToString() & "'+'" & dr("供應商編號").ToString() & "'"
                                    ds7 = Db.Get_DataSet(sql7)

                                End If
                            End If
                        End If

                        If Not dr.Item("最後到貨時間") Is DBNull.Value Then
                            Dim time4 As DateTime = dr("最後到貨時間").ToString()

                            If time4 > dateline1 And dr("箱數") = dr("已查收") Then
                                Me.GridView1.Rows(k).BackColor = Color.LightCoral

                                Dim sql1 As String = "select 異常編號 from Exception_view where 異常編號='01'+'" & dr("預定日期").ToString() & "'+'" & dr("預定時間").ToString() & "'+'" & dr("箱數").ToString() & "'+'" & dr("供應商編號").ToString() & "'"
                                ds1 = Db.Get_DataSet(sql1)
                                If ds1.Tables(0).Rows.Count = 0 Then
                                    If dr("箱數") = dr("已查收") Then
                                        Dim a As DateTime = dr("最後到貨時間").ToString()
                                        Dim sql2 As String = "insert into Exception_view (異常編號,異常日期,異常種類,異常對象,計畫時間,實際時間,異常調查原因,再發防止,責任部屬,簽核狀態,受入場,send_mail,status,modify1,modify2,modify_reason1,modify_reason2) values('01'+'" & dr("預定日期").ToString() & "'+'" & dr("預定時間").ToString() & "'+'" & dr("箱數").ToString() & "'+'" & dr("供應商編號").ToString() & "','" & dr("預定日期") & "','作業時間異常','" & dr("供應商") & "','" & dateline.ToString("HH:mm") & "','" & a.ToString("HH:mm") & "','','','','填寫中','" & dr("受入場") & "','0','楊琇雯',0,0,'','')"
                                        ds2 = Db.Get_DataSet(sql2)
                                    ElseIf dr("箱數") <> dr("已查收") Then
                                        Dim a As String = ""
                                        Dim sql2 As String = "insert into Exception_view (異常編號,異常日期,異常種類,異常對象,計畫時間,實際時間,異常調查原因,再發防止,責任部屬,簽核狀態,受入場,send_mail,status,modify1,modify2,modify_reason1,modify_reason2) values('01'+'" & dr("預定日期").ToString() & "'+'" & dr("預定時間").ToString() & "'+'" & dr("箱數").ToString() & "'+'" & dr("供應商編號").ToString() & "','" & dr("預定日期") & "','作業時間異常','" & dr("供應商") & "','" & dateline.ToString("HH:mm") & "','" & a.ToString() & "','','','','填寫中','" & dr("受入場") & "','0','楊琇雯',0,0,'','')"
                                        ds2 = Db.Get_DataSet(sql2)
                                    End If
                                End If

                                Dim sql6 As String = "select send_mail from Exception_view where 異常編號 ='01'+'" & dr("預定日期").ToString() & "'+'" & dr("預定時間").ToString() & "'+'" & dr("箱數").ToString() & "'+'" & dr("供應商編號").ToString() & "'"
                                ds6 = Db.Get_DataSet(sql6)
                                Dim dr3 As DataRow = ds6.Tables(0).Rows(0)

                                If ds6.Tables(0).Rows.Count > 0 Then
                                    If dr3("send_mail") = 0 Then

                                        Dim number As String = "01" & dr("預定日期").ToString() & dr("預定時間").ToString() & dr("箱數").ToString() & dr("供應商編號").ToString()
                                        Dim company As String = dr("供應商") + "點收作業時間異常"

                                        If dr("供應商編號") = "F11" Or dr("供應商編號") = "F12" Or dr("供應商編號") = "F27" Or dr("供應商編號") = "F32" Or dr("供應商編號") = "F35" Or dr("供應商編號") = "F54" Or dr("供應商編號") = "F55" Or dr("供應商編號") = "F56" Or dr("供應商編號") = "F57" Or dr("供應商編號") = "F58" Or dr("供應商編號") = "F59" Or dr("供應商編號") = "F60" Then
                                            Dim sql8 As String = "select EL.user_id,user_dept,EL.user_name ,user_position ,user_mail,user_group ,Exception_LxP .permission  from Exception_Login EL inner join Exception_LxP on Exception_LxP.user_id =EL.user_id   where  permission= '第一接收者2' order by user_id ASC"
                                            ds8 = Db.Get_DataSet(sql8)
                                            Dim user_all As String = ""
                                            If ds8.Tables(0).Rows.Count > 0 Then
                                                For i As Integer = 0 To ds8.Tables(0).Rows.Count() - 1
                                                    Dim dr1 As DataRow = ds8.Tables(0).Rows(i)
                                                    Dim user_mail1 As String = dr1("user_mail").ToString()
                                                    user_all = user_all & dr1("user_mail") & ","
                                                Next
                                            End If
                                            Dim user_all1 As String = user_all.Substring(0, user_all.Length() - 1)

                                            Dim sql5 As String = "select EL.user_id,user_dept,EL.user_name ,user_position ,user_mail,user_group ,Exception_LxP .permission  from Exception_Login EL inner join Exception_LxP on Exception_LxP.user_id =EL.user_id   where  permission= 'CC2' order by user_id ASC"
                                            ds5 = Db.Get_DataSet(sql5)
                                            Dim user_CCall As String = ""
                                            If ds5.Tables(0).Rows.Count > 0 Then
                                                For i As Integer = 0 To ds5.Tables(0).Rows.Count() - 1
                                                    Dim dr2 As DataRow = ds5.Tables(0).Rows(i)
                                                    Dim user_mail2 As String = dr2("user_mail").ToString()
                                                    user_CCall = user_CCall & dr2("user_mail") & ","
                                                Next
                                            End If
                                            Dim user_CCall1 As String = user_CCall.Substring(0, user_CCall.Length() - 1)
                                            mail.send_mail1("" & user_all1 & "", "" & user_CCall1 & "", company, number)

                                        Else
                                            Dim sql4 As String = "select EL.user_id,user_dept,EL.user_name ,user_position ,user_mail,user_group ,Exception_LxP .permission  from Exception_Login EL inner join Exception_LxP on Exception_LxP.user_id =EL.user_id   where  permission= '第一接收者1' order by user_id ASC"
                                            ds4 = Db.Get_DataSet(sql4)
                                            Dim user_all As String = ""
                                            If ds4.Tables(0).Rows.Count > 0 Then
                                                For i As Integer = 0 To ds4.Tables(0).Rows.Count() - 1
                                                    Dim dr1 As DataRow = ds4.Tables(0).Rows(i)
                                                    Dim user_mail1 As String = dr1("user_mail").ToString()
                                                    user_all = user_all & dr1("user_mail") & ","
                                                Next
                                            End If
                                            Dim user_all1 As String = user_all.Substring(0, user_all.Length() - 1)


                                            Dim sql5 As String = "select EL.user_id,user_dept,EL.user_name ,user_position ,user_mail,user_group ,Exception_LxP .permission  from Exception_Login EL inner join Exception_LxP on Exception_LxP.user_id =EL.user_id   where  permission= 'CC1' order by user_id ASC"
                                            ds5 = Db.Get_DataSet(sql5)
                                            Dim user_CCall As String = ""
                                            If ds5.Tables(0).Rows.Count > 0 Then
                                                For i As Integer = 0 To ds5.Tables(0).Rows.Count() - 1
                                                    Dim dr2 As DataRow = ds5.Tables(0).Rows(i)
                                                    Dim user_mail2 As String = dr2("user_mail").ToString()
                                                    user_CCall = user_CCall & dr2("user_mail") & ","
                                                Next
                                            End If
                                            Dim user_CCall1 As String = user_CCall.Substring(0, user_CCall.Length() - 1)
                                            mail.send_mail1("" & user_all1 & "", "" & user_CCall1 & "", company, number)

                                        End If

                                        Dim sql7 As String = "update Exception_view set send_mail ='1' where 異常編號 ='01'+'" & dr("預定日期").ToString() & "'+'" & dr("預定時間").ToString() & "'+'" & dr("箱數").ToString() & "'+'" & dr("供應商編號").ToString() & "'"
                                        ds7 = Db.Get_DataSet(sql7)

                                    End If
                                End If
                            End If
                        End If
                End If
            Next
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
    Protected Sub DropDownList1_SelectedIndexChanged(sender As Object, e As EventArgs) Handles DropDownList1.SelectedIndexChanged
        Try
            dataview()
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
    Protected Sub GridView1_RowDataBound(sender As Object, e As GridViewRowEventArgs)
    End Sub
    Protected Sub GridView1_RowCommand(sender As Object, e As GridViewCommandEventArgs)
    End Sub
    Protected Sub LinkButton1_Click(sender As Object, e As EventArgs) Handles LinkButton1.Click  '登出
        Try
            Session("Exception") = ""
            Response.Redirect("Default.aspx")
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
    Protected Sub LinkButton6_Click(sender As Object, e As EventArgs) Handles LinkButton6.Click
        Response.Redirect("special_case.aspx")
    End Sub
    Protected Sub LinkButton7_Click(sender As Object, e As EventArgs) Handles LinkButton7.Click
        Response.Redirect("Account_creat.aspx")
    End Sub
    Protected Sub ImageButton1_Click(sender As Object, e As ImageClickEventArgs)
        Response.Redirect("Home_page.aspx")
    End Sub
    Protected Sub ImageButton2_Click(sender As Object, e As ImageClickEventArgs)
        Response.Redirect("Exception_view.aspx")
    End Sub
    Protected Sub ImageButton3_Click(sender As Object, e As ImageClickEventArgs)
        Response.Redirect("Exception_handle.aspx")
    End Sub
    Protected Sub ImageButton4_Click(sender As Object, e As ImageClickEventArgs)
        Response.Redirect("Review.aspx")
    End Sub
    Private Sub after_4oclock()
        Try
            Dim now_time As DateTime = time
            If now_time.Hour >= 16 Then
                Dim sql1 As String = "select send from Exception_sendmail where date='" & time.ToString("yyyy-MM-dd") & "' and send='1'"
                ds1 = Db.Get_DataSet(sql1)
                If ds1.Tables(0).Rows.Count = 0 Then
                    Dim sql2 As String = "insert into Exception_sendmail (date,send) values('" & time.ToString("yyyy-MM-dd") & "','0')"
                    ds2 = Db.Get_DataSet(sql2)

                    Dim number As String = ""
                    Dim company As String = "當日部品到貨業務異常通知"
                    Dim sql As String = "select user_mail  from Exception_Login EL inner join Exception_LxP on Exception_LxP.user_id =EL.user_id   where  permission= '通知1' or permission= '通知2' or permission= '通知3'"
                    ds4 = Db.Get_DataSet(sql)
                    Dim user_all As String = ""
                    If ds4.Tables(0).Rows.Count > 0 Then
                        For i As Integer = 0 To ds4.Tables(0).Rows.Count() - 1
                            Dim dr As DataRow = ds4.Tables(0).Rows(i)
                            Dim user_mail1 As String = dr("user_mail").ToString()
                            user_all = user_all & dr("user_mail") & ","
                        Next
                    End If
                    Dim user_all1 As String = user_all.Substring(0, user_all.Length() - 1)
                    mail.send_mail3("" & user_all1 & "", company, number)

                    Dim sql3 As String = "update Exception_sendmail set send='1'  where date='" & time.ToString("yyyy-MM-dd") & "'"
                    ds3 = Db.Get_DataSet(sql3)
                End If
            End If
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
End Class