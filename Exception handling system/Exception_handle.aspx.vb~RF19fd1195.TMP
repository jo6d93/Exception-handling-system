Public Class Exception_handle
    Inherits System.Web.UI.Page
    Dim ds As DataSet
    Dim ds1 As DataSet
    Dim ds2 As DataSet
    Dim ds3 As DataSet
    Dim ds4 As DataSet
    Dim ds5 As DataSet
    Dim page_id As String = ""
    Dim time As DateTime
    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        Try
            Db.Set_Db("172.30.4.225", "DNTW_Warehouse")
            page_id = If((Request.QueryString("id") Is Nothing), "", Request.QueryString("id"))
            Session("Exception") = "http://172.30.4.225/Exception_handle.aspx?id=" + page_id
            Dim a As String = Session("Exception")

            If Session("user_id") = "" Then
                Response.Redirect("Default.aspx")
            End If
            '新增/更新
            Button1.Attributes.Add("onclick", "return confirm('責任部屬送出後不可再更改，是否要更新內容並發送給責任部屬?')")
            Button2.Attributes.Add("onclick", "return confirm('是否要更新，並發送給主管?')")

            '駁回
            Button4.Attributes.Add("onclick", "return confirm('是否要發回給上一位填寫者重寫?')")
            Button5.Attributes.Add("onclick", "return confirm('是否要發回給上一位填寫者重寫?')")

            '權限
            user_name1()
            DDL()
            BindData()
            If Not Page.IsPostBack Then
                If Session("異常編號") = "" And page_id = "" Then
                    Panel1.Visible = False
                    Panel4.Visible = True
                Else
                    Panel1.Visible = True
                    Panel4.Visible = False
                End If
            End If
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
    Private Sub DDL()
        Try
            Dim sql As String = "select user_id,user_name,user_mail from Exception_Login  where( user_dept ='生管課' or user_dept ='物流課' ) and (user_position ='班長' or user_position ='擔當')"
            ds = Db.Get_DataSet(sql)
            If ds.Tables(0).Rows.Count > 0 Then
                DropDownList1.Items.Add("請選擇責任部屬")
                For i As Integer = 0 To ds.Tables(0).Rows.Count - 1
                    Dim dr As DataRow = ds.Tables(0).Rows(i)
                    DropDownList1.Items.Add(dr("user_name"))
                Next
            End If
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
    Private Sub user_name1() '權限
        Try
            Dim sql As String = "select user_id ,user_name ,user_dept ,user_group  from Exception_Login  where user_id = '" & Session("user_id").Trim() & "'"
            ds5 = Db.Get_DataSet(sql)
            Dim dr As DataRow = ds5.Tables(0).Rows(0)
            If ds5.Tables(0).Rows.Count > 0 Then
                user_name.Text = dr("user_name").ToString()
                Session("user_name") = dr("user_name").ToString()
                Session("user_id") = dr("user_id").ToString()
            End If

            If dr("user_group") = "承認者" Then
                ImageButton4.Visible = True
            Else
                ImageButton4.Visible = False
            End If

            If dr("user_group") = "承認者" Or dr("user_group") = "檢討者" Or dr("user_group") = "填寫者" Then
                Button1.Visible = True
                Button2.Visible = True

            End If

            Button4.Visible = False
            Button5.Visible = False

        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
    Private Sub BindData()
        Try
            Dim sql As String = "select  異常編號, 異常日期 ,異常種類,異常對象 ,計畫時間 ,實際時間 , CONVERT(varchar(20),(異常調查原因)) AS 異常調查原因,CONVERT(varchar(20),(再發防止)) AS 再發防止,CONVERT(varchar(20),(責任部屬)) AS 責任部屬 ,審核狀態 ,受入場 from Exception_view  " &
                                 "where 1=1 and "
            If page_id = "" Then
                sql += "異常編號='" & Session("異常編號").ToString().Trim() & "'"
            Else
                sql += "異常編號='" & page_id.ToString().Trim() & "'"
            End If
            sql += "ORDER BY 計畫時間 ASC"

            ds = Db.Get_DataSet(sql)
            Dim dr As DataRow = ds.Tables(0).Rows(0)

            If ds.Tables(0).Rows.Count > 0 Then
                ds.Tables(0).Columns.Add(New DataColumn("no", GetType(String)))

                For k As Integer = 0 To ds.Tables(0).Rows.Count - 1
                    Dim dr1 As DataRow = ds.Tables(0).Rows(k)
                    dr1("no") = k + 1
                    Session("異常編號") = dr1("異常編號")
                Next
                GridView1.DataSource = ds.Tables(0)
                GridView1.DataBind()

                '下方框
                textbox2_intext()
                textbox3_intext()

                history()
                history1()
            End If

            Dim sql1 As String = "select EL.user_id,user_dept,EL.user_name ,user_position ,user_mail,user_group ,Exception_LxP .permission,user_group  from Exception_Login EL inner join Exception_LxP on Exception_LxP.user_id =EL.user_id   where EL.user_id = '" & Session("user_id").Trim() & "' order by user_id ASC"
            ds1 = Db.Get_DataSet(sql1)
            Dim dr2 As DataRow = ds1.Tables(0).Rows(0)

            If dr("審核狀態") = "簽核通過" Then
                Button1.Visible = False
                Button2.Visible = False
                Button4.Visible = False
                Button5.Visible = False
            End If

            Dim sql3 As String = "select responsibility from Exception_view where 異常編號='" & Session("異常編號").ToString().ToString.Trim() & "'"
            ds3 = Db.Get_DataSet(sql3)
            Dim dr3 As DataRow = ds3.Tables(0).Rows(0)
            If Not dr3("responsibility") Is DBNull.Value Then
                DropDownList1.Visible = False
                Button1.Visible = False
                TextBox1.Text = DropDownList1.Text.ToString.Trim()
                TextBox1.Visible = True
                TextBox1.ReadOnly = True
            Else
                TextBox1.Visible = False
                DropDownList1.Visible = True
                Button1.Visible = True
            End If
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
    Private Sub SQL_time()
        Try
            Dim sql_time As String = "select getdate() AS SERVER_TIME"
            ds1 = Db.Get_DataSet(sql_time)
            time = ds1.Tables(0).Rows(0)("SERVER_TIME").ToString()
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
    Private Sub textbox2_intext()
        Try
            Dim sql As String = "select 異常調查原因 from Exception_view where 異常編號='" & Session("異常編號").ToString().ToString.Trim() & "'"
            ds = Db.Get_DataSet(sql)
            Dim dr As DataRow = ds.Tables(0).Rows(0)

            If dr("異常調查原因") <> "" Then
                Button1.Text = "修改"
                TextBox2.Text = dr("異常調查原因").ToString()

                Dim dr1 As DataRow = ds5.Tables(0).Rows(0)
                If dr1("user_group") = "承認者" Or dr1("user_group") = "檢討者" Then
                    Button4.Visible = True
                    Label7.Visible = False
                End If
            Else
                Button1.Text = "新增"
            End If
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
    Private Sub textbox3_intext()
        Try
            Dim sql As String = "select 再發防止 from Exception_view where 異常編號='" & Session("異常編號").ToString().ToString.Trim() & "'"
            ds = Db.Get_DataSet(sql)
            Dim dr As DataRow = ds.Tables(0).Rows(0)

            If dr("再發防止") <> "" Then
                Button2.Text = "修改"
                TextBox3.Text = dr("再發防止").ToString()
                Dim dr1 As DataRow = ds5.Tables(0).Rows(0)
                If dr1("user_group") = "承認者" Or dr1("user_group") = "檢討者" Then
                    Button5.Visible = True
                    Label8.Visible = False
                End If
            Else
                Button2.Text = "新增"
            End If
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
    Private Sub button2_case()
        Try
            Dim sql As String = "select 再發防止 from Exception_view where 異常編號='" & Session("異常編號").ToString().ToString.Trim() & "'"
            ds = Db.Get_DataSet(sql)
            If ds.Tables(0).Rows.Count > 0 Then
                Dim dr As DataRow = ds.Tables(0).Rows(0)
                If dr("再發防止").ToString() <> TextBox3.Text.ToString() Then
                    Dim sql1 As String = "update Exception_view set 再發防止='" & TextBox3.Text.ToString() & "'where 異常編號='" & Session("異常編號").ToString().ToString.Trim() & "'"
                    ds1 = Db.Get_DataSet(sql1)
                    SQL_time()
                    Dim sql2 As String = "insert into Exception_history (異常編號 ,user_name,修改人員編號 ,修改時間 , 修改後內容 ,欄位)values('" & Session("異常編號").ToString().ToString.Trim() & "','" & Session("user_name") & "','" & Session("user_id") & "', '" & time.ToString("yyyy-MM-dd HH:mm:ss") & "','" & TextBox2.Text.ToString() & "','再發防止')"
                    ds2 = Db.Get_DataSet(sql2)
                    If TextBox2.Text.ToString() <> "" And TextBox3.Text.ToString() <> "" Then
                        Dim sql4 As String = "update Exception_view set 審核狀態='尚未簽核'  where 異常編號='" & Session("異常編號").ToString().ToString.Trim() & "'"
                        ds3 = Db.Get_DataSet(sql4)

                    End If
                    set_mail2()
                Else
                    BindData()
                End If
                Dim sql3 As String = "select user_name AS 修改者,修改時間 from Exception_history where 欄位='再發防止' and  異常編號='" & Session("異常編號").ToString().ToString.Trim() & "' ORDER BY 修改時間 DESC"
                ds1 = Db.Get_DataSet(sql3)
                If ds1.Tables(0).Rows.Count > 0 Then
                    GridView3.DataSource = ds1.Tables(0)
                    GridView3.DataBind()
                End If
            End If
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
    Protected Sub Button1_Click(sender As Object, e As EventArgs) '異常調查原因
        Try
            Dim sql As String = "select 異常調查原因 from Exception_view where 異常編號='" & Session("異常編號").ToString().ToString.Trim() & "'"
            ds = Db.Get_DataSet(sql)
            Dim dr As DataRow = ds.Tables(0).Rows(0)

            Select Case Button1.Text
                Case "修改"
                    If ds.Tables(0).Rows.Count > 0 Then
                        If dr("異常調查原因").ToString() <> TextBox2.Text.ToString() Then
                            Dim sql1 As String = "update Exception_view set 異常調查原因='" & TextBox2.Text.ToString() & "'  where 異常編號='" & Session("異常編號").ToString().ToString.Trim() & "'"
                            ds1 = Db.Get_DataSet(sql1)
                            SQL_time()
                            Dim sql2 As String = "insert into Exception_history (異常編號,user_name,修改人員編號,修改時間, 修改後內容,欄位)values('" & Session("異常編號").ToString.Trim() & "','" & Session("user_name").ToString.Trim() & "','" & Session("user_id").ToString.Trim() & "','" & time.ToString("yyyy-MM-dd HH:mm:ss") & "','" & TextBox2.Text.ToString.Trim() & "','異常調查原因')"
                            ds2 = Db.Get_DataSet(sql2)

                            If TextBox2.Text.ToString() <> "" And TextBox3.Text.ToString() <> "" Then
                                Dim sql4 As String = "update Exception_view set 審核狀態='尚未簽核'  where 異常編號='" & Session("異常編號").ToString().ToString.Trim() & "'"
                                ds3 = Db.Get_DataSet(sql4)
                            End If

                            Dim sql3 As String = "select responsibility from Exception_view where 異常編號='" & Session("異常編號").ToString().ToString.Trim() & "'"
                            ds3 = Db.Get_DataSet(sql3)
                            If ds3.Tables(0).Rows.Count > 0 Then
                                Dim dr1 As DataRow = ds3.Tables(0).Rows(0)
                                If dr1("responsibility") Is DBNull.Value Then
                                    set_mail1()

                                    Dim sql4 As String = "update Exception_view set responsibility='" & DropDownList1.Text.ToString.Trim() & "'  where 異常編號='" & Session("異常編號").ToString().ToString.Trim() & "'"
                                    ds4 = Db.Get_DataSet(sql4)

                                    DropDownList1.Visible = False
                                    TextBox1.Text = dr1("responsibility")
                                    TextBox1.Visible = True
                                    TextBox1.ReadOnly = True

                                ElseIf Not dr1("responsibility") Is DBNull.Value Then
                                    DropDownList1.Visible = False
                                    TextBox1.Text = dr1("responsibility")
                                    TextBox1.Visible = True
                                    TextBox1.ReadOnly = True

                                Else
                                    BindData()
                                End If
                            Else
                                BindData()
                            End If
                        Else
                            BindData()
                        End If
                        history()
                        BindData()
                    End If
                Case "新增"
                    If ds.Tables(0).Rows.Count > 0 Then
                        If dr("異常調查原因").ToString() <> TextBox2.Text.ToString() Then
                            Dim sql1 As String = "update Exception_view set 異常調查原因='" & TextBox2.Text.ToString() & "'  where 異常編號='" & Session("異常編號").ToString().ToString.Trim() & "'"
                            ds1 = Db.Get_DataSet(sql1)
                            SQL_time()
                            Dim sql2 As String = "insert into Exception_history (異常編號,user_name,修改人員編號,修改時間, 修改後內容,欄位)values('" & Session("異常編號").ToString.Trim() & "','" & Session("user_name").ToString.Trim() & "','" & Session("user_id").ToString.Trim() & "','" & time.ToString("yyyy-MM-dd HH:mm:ss") & "','" & TextBox2.Text.ToString.Trim() & "','異常調查原因')"
                            ds2 = Db.Get_DataSet(sql2)

                            If TextBox2.Text.ToString() <> "" And TextBox3.Text.ToString() <> "" Then
                                Dim sql4 As String = "update Exception_view set 審核狀態='尚未簽核'  where 異常編號='" & Session("異常編號").ToString().ToString.Trim() & "'"
                                ds3 = Db.Get_DataSet(sql4)
                            End If

                            Dim sql3 As String = "select responsibility from Exception_view where 異常編號='" & Session("異常編號").ToString().ToString.Trim() & "'"
                            ds3 = Db.Get_DataSet(sql3)
                            If ds3.Tables(0).Rows.Count > 0 Then
                                Dim dr1 As DataRow = ds3.Tables(0).Rows(0)
                                If dr1("responsibility") Is DBNull.Value Then
                                    set_mail1()

                                    Dim sql4 As String = "update Exception_view set responsibility='" & DropDownList1.Text.ToString.Trim() & "'  where 異常編號='" & Session("異常編號").ToString().ToString.Trim() & "'"
                                    ds4 = Db.Get_DataSet(sql4)
                                    Dim debug As String = DropDownList1.Text.ToString.Trim()

                                ElseIf Not dr1("responsibility") Is DBNull.Value Then
                                    DropDownList1.Visible = False
                                    TextBox1.Text = dr1("responsibility")
                                    TextBox1.Visible = True
                                    TextBox1.ReadOnly = True

                                Else
                                    BindData()
                                End If
                            Else
                                BindData()
                            End If
                        Else
                            BindData()
                        End If
                        history()
                        BindData()
                    End If
            End Select
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
    Protected Sub Button2_Click(sender As Object, e As EventArgs) '再發防止
        Try
            Select Case Button2.Text
                Case "修改"
                    button2_case()
                    BindData()
                Case "新增"
                    button2_case()
                    BindData()
            End Select
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
    Private Sub history()
        Try
            Dim sql As String = "select user_name AS 修改者,修改時間 from Exception_history where 欄位='異常調查原因' and  異常編號='" & Session("異常編號").ToString().ToString.Trim() & "' ORDER BY 修改時間 DESC"
            ds = Db.Get_DataSet(sql)
            If ds.Tables(0).Rows.Count > 0 Then
                GridView4.DataSource = ds.Tables(0)
                GridView4.DataBind()
            End If
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
    Private Sub history1()
        Try
            Dim sql As String = "select user_name AS 修改者,修改時間 from Exception_history where 欄位='再發防止' and  異常編號='" & Session("異常編號").ToString().ToString.Trim() & "' ORDER BY 修改時間 DESC"
            ds = Db.Get_DataSet(sql)
            If ds.Tables(0).Rows.Count > 0 Then
                GridView3.DataSource = ds.Tables(0)
                GridView3.DataBind()
            End If
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
    Protected Sub GridView3_PageIndexChanging(sender As Object, e As GridViewPageEventArgs)
        Try
            GridView3.PageIndex = e.NewPageIndex
            BindData()
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
    Protected Sub GridView4_PageIndexChanging(sender As Object, e As GridViewPageEventArgs)
        Try
            GridView4.PageIndex = e.NewPageIndex
            BindData()
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
    Protected Sub Button4_Click(sender As Object, e As EventArgs)
        Try
            Dim sql As String = "select 異常對象,異常種類,異常編號 from Exception_view where 異常編號 ='" & Session("異常編號").ToString().ToString.Trim() & "'"
            ds = Db.Get_DataSet(sql)
            Dim dr As DataRow = ds.Tables(0).Rows(0)
            Dim number As String = dr("異常編號")
            Dim company As String = dr("異常對象") + dr("異常種類") + "-異常調查原因請重寫!"

            Dim sql1 As String = "select  EL.user_id ,user_mail,MAX(Eh.修改時間) AS 最後修改時間  from Exception_Login EL INNER JOIN Exception_history Eh on EL.user_id =Eh.修改人員編號 where 異常編號 ='" & Session("異常編號").ToString().ToString.Trim() & "' and 欄位='異常調查原因' Group by 異常編號,欄位,user_id,user_mail order by 最後修改時間 DESC"
            ds1 = Db.Get_DataSet(sql1)
            Dim dr1 As DataRow = ds1.Tables(0).Rows(0)
            Dim user_mail As String = dr1("user_mail")
            mail.send_mail(user_mail, company, number)
            Button4.Visible = False
            Label7.Visible = True
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
    Protected Sub Button5_Click(sender As Object, e As EventArgs)
        Try
            Dim sql As String = "select 異常對象,異常種類,異常編號 from Exception_view where 異常編號 ='" & Session("異常編號").ToString().ToString.Trim() & "'"
            ds = Db.Get_DataSet(sql)
            Dim dr As DataRow = ds.Tables(0).Rows(0)
            Dim number As String = dr("異常編號")
            Dim company As String = dr("異常對象") + dr("異常種類") + "-再發防止請重寫!"

            Dim sql1 As String = "select  EL.user_id ,user_mail,MAX(Eh.修改時間) AS 最後修改時間  from Exception_Login EL INNER JOIN Exception_history Eh on EL.user_id =Eh.修改人員編號 where 異常編號 ='" & Session("異常編號").ToString().ToString.Trim() & "' and 欄位='再發防止' Group by 異常編號,欄位,user_id,user_mail order by 最後修改時間 DESC"
            ds1 = Db.Get_DataSet(sql1)
            Dim dr1 As DataRow = ds1.Tables(0).Rows(0)
            Dim user_mail As String = dr1("user_mail")
            mail.send_mail(user_mail, company, number)
            Button5.Visible = False
            Label8.Visible = True
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
    Protected Sub LinkButton1_Click(sender As Object, e As EventArgs) Handles LinkButton1.Click
        Try
            Session("Exception") = ""
            Response.Redirect("Default.aspx")
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
    Protected Sub ImageButton1_Click(sender As Object, e As ImageClickEventArgs)
        Response.Redirect("Home_page.aspx")
    End Sub
    Protected Sub ImageButton2_Click(sender As Object, e As ImageClickEventArgs)
        Response.Redirect("Exception_view.aspx")
    End Sub
    Protected Sub ImageButton3_Click(sender As Object, e As ImageClickEventArgs)
        Response.Redirect("Exception_handle.aspx")
    End Sub
    Protected Sub ImageButton4_Click(sender As Object, e As ImageClickEventArgs)
        Response.Redirect("Review.aspx")
    End Sub
    Private Sub set_mail1()
        '寄信
        Try
            Dim sql As String = "select user_id,user_name,user_mail  from Exception_Login where user_name='" & DropDownList1.Text.ToString.Trim() & "'"
            ds = Db.Get_DataSet(sql)

            If ds.Tables(0).Rows.Count > 0 Then
                Dim dr As DataRow = ds.Tables(0).Rows(0)

                Dim user_mail As String = dr("user_mail")

                Dim sql1 As String = "select 異常對象,異常種類,異常編號 from Exception_view where 異常編號 ='" & Session("異常編號").ToString().ToString.Trim() & "'"
                ds1 = Db.Get_DataSet(sql1)
                If ds1.Tables(0).Rows.Count > 0 Then
                    Dim dr1 As DataRow = ds1.Tables(0).Rows(0)
                    Dim number As String = dr1("異常編號")
                    Dim company As String = Session("user_name") + "對於" + dr1("異常對象") + dr1("異常種類") + "-異常調查原因已填寫"
                    mail.send_mail(user_mail, company, number)
                End If
            End If
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
    Private Sub set_mail2() '擔當->檢討者
        '寄信
        Try
            Dim sql As String = "select EL.user_id,user_dept,EL.user_name ,user_position ,user_mail,user_group ,Exception_LxP .permission  from Exception_Login EL inner join Exception_LxP on Exception_LxP.user_id =EL.user_id   where EL.user_id='" & Session("user_id") & "' and permission like '填寫者%' order by user_id ASC"
            ds = Db.Get_DataSet(sql)
            If ds.Tables(0).Rows.Count > 0 Then
                Dim dr As DataRow = ds.Tables(0).Rows(0)
                Dim pms As String = dr("permission")
                Dim pms_L As Integer = pms.Length()
                Dim pms_n As Integer = 0
                If pms_L = 4 Then
                    pms_n = CInt(pms.Substring(3, 1))
                ElseIf pms_L = 5 Then
                    pms_n = CInt(pms.Substring(3, 2))
                End If
                Dim sql1 As String = "select 異常對象,異常種類,異常編號 from Exception_view where 異常編號 ='" & Session("異常編號").ToString().ToString.Trim() & "'"
                ds1 = Db.Get_DataSet(sql1)
                If ds1.Tables(0).Rows.Count > 0 Then
                    Dim dr1 As DataRow = ds1.Tables(0).Rows(0)
                    Dim number As String = dr1("異常編號")
                    Dim company As String = dr("user_name") + "對於" + dr1("異常對象") + dr1("異常種類") + "-再發防止已填寫"

                    Dim sql2 As String = "select EL.user_id,user_dept,EL.user_name ,user_position ,user_mail,user_group ,Exception_LxP .permission  from Exception_Login EL inner join Exception_LxP on Exception_LxP.user_id =EL.user_id   where  permission= '檢討者" & pms_n & "' order by user_id ASC"
                    ds2 = Db.Get_DataSet(sql2)
                    Dim user_all As String = ""
                    If ds2.Tables(0).Rows.Count > 0 Then
                        For i As Integer = 0 To ds2.Tables(0).Rows.Count() - 1
                            Dim dr2 As DataRow = ds2.Tables(0).Rows(i)
                            Dim user_mail1 As String = dr2("user_mail").ToString()
                            user_all = user_all & dr2("user_mail") & ","
                        Next
                    End If
                    Dim user_all1 As String = user_all.Substring(0, user_all.Length() - 1)
                    mail.send_mail(user_all1, company, number)
                End If
            End If
        Catch ex As Exception
            Dim str As String = ex.Message
        End Try
    End Sub
End Class